var $jscomp={scope:{},findInternal:function(a,b,c){a instanceof String&&(a=String(a));for(var d=a.length,e=0;e<d;e++){var f=a[e];if(b.call(c,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){if(c.get||c.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,c){return $jscomp.findInternal(this,a,c).v}},"es6-impl","es3");
var VERSION_STRING="1.5",DATA_VERSION=1,MIN_SCREEN_X=1E3,MIN_SCREEN_Y=650,BOTTOM_BOUND=60,BLOCK_CELL_SIZE=90,MAX_MOV_STEP=Math.floor(BLOCK_CELL_SIZE/4),CELL_BORDER_SIZE=0,BACKGROUND_COLOR="#FAFAD2",TITLE_COLOR="black",BOARD_BORDER_WIDTH=50,BOARD_WIDTH=BLOCK_CELL_SIZE*G_BOARD_X+2*BOARD_BORDER_WIDTH,BOARD_HEIGHT=BLOCK_CELL_SIZE*G_BOARD_Y+2*BOARD_BORDER_WIDTH,MIN_HINTS_STEP=5,MAX_HINTS_STEP=10,ACTIVE_HINTS_COUNT=15,screenX,screenY,boardStageX,boardStageY,titleStartX,titleStartY,boardStartX,boardStartY,
blockStartX,blockStartY,minX,minY,gStage,gBoardLayer,gButtonLayer,gBackgroundLayer,playSpeed=1,dataVersion=0,boardState,stepInfo,manualMoveCount=0,cellSize=BLOCK_CELL_SIZE-CELL_BORDER_SIZE;window.onload=function(){document.onselectstart=function(){return!1};init();loadResource(initBoard)};var gLevelSelectObj,gCurSelectedBoard,gPassLevelDialog,gOKDialog,gHintsCount;function init(){initScreenSize();initScreenPosColor();showLoadingMsg("dialogStage",boardStageX,boardStageY)}
function initBoard(){hideLoadingMsg();initScreenVariable();createStageLayer();addBackgroundLayer();restoreConfigInfo();gLevelSelectObj=new vSelectBoard;gCurSelectedBoard=gLevelSelectObj.init("selectMainStage","selectTabsStage","selectBoardStage",boardStageX,boardStageY,setSelectedLevel);gPassLevelDialog=new passedDialog;gOKDialog=new okDialog;stepInfo=[];manualMoveCount=gHintsCount=0;var a=getUrlArgument();null!=a?getAssignLevel(a):getPlayInfo();setPlayMode(stepInfo.length);createFunctionButton();
createGameButton();enableFunctionButton();enableVolumeButton();enableGameButton();setTimeout(function(){audioPlayStartup()},500)}var playMode=0;function clearLastModeObject(a){switch(playMode){case 1:clearPlayModeButton();break;case 2:clearDemoModeButton();break;case 3:clearEditModeButton()}playMode=a}function setButtonState(){switch(playMode){case 1:setPlayModeButtonState();break;case 2:setDemoModeButtonState();break;case 3:setEditModeButtonState()}}
function setPlayMode(a){clearLastModeObject(1);addPlayModeButton();createBoard(gCurSelectedBoard.boardInfo.board);moveBoardStep(a)}function setDemoMode(){clearLastModeObject(2);addDemoModeButton();createBoard(gCurSelectedBoard.boardInfo.board);var a=setAutoMoveStepInfo();moveBoardStep(0);return a}function setEditMode(){clearLastModeObject(3);addEditModeButton();createEditBoard();writeStepInfo(0)}
function getUrlArgument(){var a=decodeURIComponent(document.location.href);if(0>a.indexOf("?"))return null;a=a.substring(a.indexOf("?")+1).replace(/\s/g,"");return/l=\d{1,2}-\d{1,2}/.test(a)?{type:"tabsLevel",tabsLevel:a.substring(2).split("-")}:0==a.indexOf("l=")&&3<=a.length?{type:"name",name:a.substring(2)}:null}
function getAssignLevel(a){var b=null;switch(a.type){case "tabsLevel":b=parseInt(a.tabsLevel[0],10)-1;a=parseInt(a.tabsLevel[1],10);b=gLevelSelectObj.changeBoardByTabsLevel(b,a);break;case "name":b=gLevelSelectObj.changeBoardByClassicName(a.name)}null!=b&&(gCurSelectedBoard=b,stepInfo=[],manualMoveCount=gHintsCount=0)}
function getPlayInfo(){var a=restorePlayInfo();if(null!=a){var b=gLevelSelectObj.changeSelectedBoard(a);null!=b&&(gCurSelectedBoard=b,stepInfo=a.stepInfo,gHintsCount=a.hints,manualMoveCount=a.moveCount)}}
function initScreenSize(){screenY=screenX=0;"number"==typeof window.innerWidth?(screenX=window.innerWidth,screenY=window.innerHeight):document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?(screenX=document.documentElement.clientWidth,screenY=document.documentElement.clientHeight):document.body&&(document.body.clientWidth||document.body.clientHeight)&&(screenX=document.body.clientWidth,screenY=document.body.clientHeight);boardStageX=screenX<MIN_SCREEN_X?
MIN_SCREEN_X:screenX-10;boardStageY=screenY<MIN_SCREEN_Y?MIN_SCREEN_Y:screenY-10;boardStartX=Math.floor((boardStageX-BOARD_WIDTH)/2);boardStartY=Math.floor((boardStageY-BOTTOM_BOUND-BOARD_HEIGHT)/2)}
function initScreenVariable(){levelNameStartX=boardStartX+50;levelNameStartY=boardStartY+30;stepMsgStartX=boardStartX+BOARD_WIDTH-60;stepMsgStartY=boardStartY+30;titleStartY=titleStartX=10;titleScale=images.title.width+30>boardStartX?boardStartX/images.title.width-.1:1;blockStartX=Math.floor((boardStageX-G_BOARD_X*BLOCK_CELL_SIZE)/2);blockStartY=boardStartY+Math.floor((BOARD_HEIGHT-G_BOARD_Y*BLOCK_CELL_SIZE)/2);minX=blockStartX+CELL_BORDER_SIZE/2;minY=blockStartY+CELL_BORDER_SIZE/2}
function initScreenPosColor(){document.getElementById("selectMainStage").style.cssText="top:10px; left:10px; position: absolute;";document.getElementById("selectTabsStage").style.cssText="top:20px; left:20px; position: absolute;";document.getElementById("selectBoardStage").style.cssText="top:55px; left:30px; position: absolute;"}
function setSelectedLevel(a,b){stepInfo=[];manualMoveCount=gHintsCount=0;switch(playMode){case 1:case 2:gCurSelectedBoard=a;createBoard(gCurSelectedBoard.boardInfo.board);if(2==playMode){savePlayModeInfo();var c=setAutoMoveStepInfo();b&&animateTitle(gTxtMsg.DemoMode,c.time)}moveBoardStep(0);break;case 3:setEditBoard(a.boardInfo.board)}}
function createStageLayer(){gStage=new Kinetic.Stage({container:"boardStage",width:boardStageX,height:boardStageY});gBackgroundLayer=new Kinetic.Layer;gMessageLayer=new Kinetic.Layer;gButtonLayer=new Kinetic.Layer;gBoardLayer=new Kinetic.Layer;gStage.add(gBackgroundLayer);gStage.add(gMessageLayer);gStage.add(gButtonLayer);gStage.add(gBoardLayer)}
function addBackgroundLayer(){var a=new Kinetic.Text({x:15,y:boardStageY-55,text:"Klotski",fill:BACKGROUND_COLOR,fontSize:55,fontStyle:"bold",shadowColor:"black",shadowBlur:10,shadowOffset:[2,2],shadowOpacity:.3}),b=new Kinetic.Text({x:15+a.getWidth(),y:boardStageY-55/3,text:VERSION_STRING,fill:BACKGROUND_COLOR,fontSize:55/3,fontStyle:"bold",shadowColor:"black",shadowBlur:9,shadowOffset:[2,2],shadowOpacity:.3}),c=new Kinetic.Rect({x:0,y:0,width:boardStageX,height:boardStageY,fill:BACKGROUND_COLOR}),
d=new Kinetic.Rect({x:boardStartX,y:boardStartY,width:BOARD_WIDTH,height:BOARD_HEIGHT,fillPatternImage:images.board}),e=new Kinetic.Image({x:titleStartX,y:titleStartY,image:images.title,scaleX:titleScale,scaleY:titleScale});document.body.style.background=BACKGROUND_COLOR;gBackgroundLayer.add(c);gBackgroundLayer.add(e);gBackgroundLayer.add(a);gBackgroundLayer.add(b);gBackgroundLayer.add(d);gBackgroundLayer.draw()}var blockObj=[];
function createBoard(a){blockObj=[];curBoardStep=0;boardState=[];for(var b=0;b<G_BOARD_X;b++){boardState[b]=[];for(var c=0;c<G_BOARD_Y;c++)boardState[b][c]=-1}gBoardLayer.removeChildren();for(var d=1,e=0,c=0;c<G_BOARD_Y;c++)for(b=0;b<G_BOARD_X;b++)if(0<=boardState[b][c])e++;else{var f=gBlockBelongTo[a.charCodeAt(e++)-63];f&&(blockObj[d]=createBlock(d,b,c,f,1==playMode?1:0));for(var g=gBlockStyle[f][0],h=gBlockStyle[f][1],k=0;k<g;k++)for(var l=0;l<h;l++)boardState[b+k][c+l]=f?d:0;f&&d++}gBoardLayer.draw()}
function buildBoard(a){for(var b=[],c,d=0;d<G_BOARD_X;d++)b[d]=a[d].slice(0);for(a=0;a<G_BOARD_Y;a++)for(d=0;d<G_BOARD_X;d++)if(0!=(c=b[d][a])){blockObj[c].movePos(d,a);var e=blockObj[c].getAttr("sizeX");c=blockObj[c].getAttr("sizeY");for(var f=0;f<c;f++)for(var g=0;g<e;g++)b[d+g][a+f]=0}gBoardLayer.draw()}function writeMessage(a){var b=gMessageLayer.getContext();b.font="12pt arial";b.fillStyle="blue";b.fillText(a+"  ",20,20)}
function writeStepInfo(a,b){var c=gMessageLayer.getContext();gMessageLayer.clear();"undefined"==typeof b&&(b=0);b?(c.fillStyle="#C40000",c.strokeStyle="#FFBBCC"):(c.fillStyle="#0000C4",c.strokeStyle="#BABAFA");var d=12*(1-(a+"").length);c.font="17pt Calibri";c.strokeText(a,stepMsgStartX+1+d,stepMsgStartY+1);c.fillText(a,stepMsgStartX+d,stepMsgStartY);d=gCurSelectedBoard.titleInfo;3==playMode&&(d=gTxtMsg.EditMode);c.font="18pt Calibri";c.fillStyle="#BABAFA";c.fillText(d,levelNameStartX+1,levelNameStartY+
1);c.fillStyle="#0000C4";c.fillText(d,levelNameStartX,levelNameStartY)}function point2Pos(a,b){var c=posY=0,d=a-minX;for(0>d&&(d=0);d>=BLOCK_CELL_SIZE;)d-=BLOCK_CELL_SIZE,c++;var e=b-minY;for(0>e&&(e=0);e>=BLOCK_CELL_SIZE;)e-=BLOCK_CELL_SIZE,posY++;return{posX:c,posY:posY,offsetX:d,offsetY:e}}
function getShiftX(a,b,c,d,e){var f=posY=0;b-=minY;for(0>b&&(b=0);b>=BLOCK_CELL_SIZE;)b-=BLOCK_CELL_SIZE,posY++;if(0>c){a=a-minX+c;if(0>a)return c-a;for(;a>=BLOCK_CELL_SIZE;)a-=BLOCK_CELL_SIZE,f++;if(!allCellYEmpty(f,posY,e))return c+BLOCK_CELL_SIZE-a}else{a=a-minX+c+BLOCK_CELL_SIZE*d-1;for(0>a&&error("desgin error");a>=BLOCK_CELL_SIZE;)a-=BLOCK_CELL_SIZE,f++;if(f>=G_BOARD_X||!allCellYEmpty(f,posY,e))return c-a-1}return c}
function getShiftY(a,b,c,d,e){var f=posY=0;a-=minX;for(0>a&&(a=0);a>=BLOCK_CELL_SIZE;)a-=BLOCK_CELL_SIZE,f++;if(0>c){b=b-minY+c;if(0>b)return c-b;for(;b>=BLOCK_CELL_SIZE;)b-=BLOCK_CELL_SIZE,posY++;if(!allCellXEmpty(f,posY,d))return c+BLOCK_CELL_SIZE-b}else{b=b-minY+c+BLOCK_CELL_SIZE*e-1;for(0>b&&debug("desgin error");b>=BLOCK_CELL_SIZE;)b-=BLOCK_CELL_SIZE,posY++;if(posY>=G_BOARD_Y||!allCellXEmpty(f,posY,d))return c-b-1}return c}
function allCellXEmpty(a,b,c){for(var d=0;d<c;d++)if(0!=boardState[a+d][b])return 0;return 1}function allCellYEmpty(a,b,c){for(var d=0;d<c;d++)if(0!=boardState[a][b+d])return 0;return 1}function setBoardState(a,b,c,d,e){var f=gBlockStyle[d][0];d=gBlockStyle[d][1];for(var g=0;g<d;g++)for(var h=0;h<f;h++)a[b+h][c+g]=e}function stepInfo2PosInfo(a){a=stepInfo[a-1];return{id:a>>16&31,startX:a>>12&15,startY:a>>8&15,endX:a>>4&15,endY:a&15,auto:a>>21&1}}var curBoardStep=0;
function setStepInfo(a,b,c,d,e,f,g){var h=stepInfo.length;if(b==d&&c==e)return curBoardStep;!g&&h>curBoardStep&&(stepInfo.splice(curBoardStep,h-curBoardStep),h=curBoardStep);if(!f&&0!=h&&(g=stepInfo2PosInfo(h),g.endX==b&&g.endY==c))return g.startX==d&&g.startY==e?(stepInfo.pop(),h--):stepInfo[h-1]=((f?1:0)<<21)+(a<<16)+(g.startX<<12)+(g.startY<<8)+(d<<4)+e,curBoardStep=h;stepInfo[h++]=((f?1:0)<<21)+(a<<16)+(b<<12)+(c<<8)+(d<<4)+e;f||(curBoardStep=h,manualMoveCount++);return h}
function getStepAction(a,b,c){var d,e,f,g,h,k=[];b?(b=a.startX-a.endX,d=a.startY-a.endY,g=a.endX,h=a.endY):(b=a.endX-a.startX,d=a.endY-a.startY,g=a.startX,h=a.startY);e=blockObj[a.id].getAttr("style");f=gBlockStyle[e][0];for(e=gBlockStyle[e][1];b||d;){for(var l=0;0>d&&1==allCellXEmpty(g,h-1,f);)k.push("U"),d++,h--,l=1;for(;0<d&&1==allCellXEmpty(g,h+e,f);)k.push("D"),d--,h++,l=1;for(;0>b&&1==allCellYEmpty(g-1,h,e);)k.push("L"),b++,g--,l=1;for(;0<b&&1==allCellYEmpty(g+f,h,e);)k.push("R"),b--,g++,l=
1;if(!l){error("getStepAction(): design error!");break}}if(c){c=[];b=k.length;for(d=0;d<b;d++)switch(k[b-1-d]){case "U":c[d]="D";break;case "D":c[d]="U";break;case "L":c[d]="R";break;case "R":c[d]="L"}k=c}debug("id="+a.id+" "+k);return{auto:a.auto,move:k}}
function createBlock(a,b,c,d,e){b=new Kinetic.Rect({id:a,startPosX:b,startPosY:c,sizeX:gBlockStyle[d][0],sizeY:gBlockStyle[d][1],style:d,blockMoved:0,x:minX+BLOCK_CELL_SIZE*b,y:minY+BLOCK_CELL_SIZE*c,width:BLOCK_CELL_SIZE*gBlockStyle[d][0]-CELL_BORDER_SIZE,height:BLOCK_CELL_SIZE*gBlockStyle[d][1]-CELL_BORDER_SIZE,fillPatternImage:images["block"+d],strokeWidth:CELL_BORDER_SIZE,draggable:e,dragBoundFunc:function(a){var c=this.getPosition().x,b=this.getPosition().y,d=a.x-c;a=a.y-b;Math.abs(d)>MAX_MOV_STEP&&
(d=0<d?MAX_MOV_STEP:-MAX_MOV_STEP);Math.abs(a)>MAX_MOV_STEP&&(a=0<a?MAX_MOV_STEP:-MAX_MOV_STEP);var e=0,n=0,p=0,m=point2Pos(c,b);switch(!0){case 0==m.offsetX&&0==m.offsetY:0>a&&0<m.posY&&allCellXEmpty(m.posX,m.posY-1,this.getAttr("sizeX"))&&(n=1);0<a&&m.posY+this.getAttr("sizeY")<G_BOARD_Y&&allCellXEmpty(m.posX,m.posY+this.getAttr("sizeY"),this.getAttr("sizeX"))&&(n=2);0>d&&0<m.posX&&allCellYEmpty(m.posX-1,m.posY,this.getAttr("sizeY"))&&(e=3);0<d&&m.posX+this.getAttr("sizeX")<G_BOARD_X&&allCellYEmpty(m.posX+
this.getAttr("sizeX"),m.posY,this.getAttr("sizeY"))&&(e=4);switch(!0){case 0!=n&&0!=e:p=Math.abs(d)>Math.abs(a)?e:n;break;case 0!=n:p=n;break;case 0!=e:p=e}break;case 0==m.offsetX:0>a?p=1:0<a&&(p=2);break;case 0==m.offsetY:0>d?p=3:0<d&&(p=4);break;default:error("createBlock(): design error !")}if(0==p)return{x:c,y:b};switch(p){case 1:case 2:d=0;a=getShiftY(c,b,a,this.getAttr("sizeX"),this.getAttr("sizeY"));break;case 3:case 4:a=0;d=getShiftX(c,b,d,this.getAttr("sizeX"),this.getAttr("sizeY"));break;
default:error("createBlock(): design error")}0==d&&0==a||this.setAttrs({blockMoved:1});return{x:c+d,y:b+a}}});b.setPos=function(a,c){this.setAttrs({startPosX:a,startPosY:c})};b.movePos=function(a,c){var b=minX+a*BLOCK_CELL_SIZE,d=minY+c*BLOCK_CELL_SIZE;this.setAttrs({startPosX:a,startPosY:c});this.setPosition(b,d)};e&&enableBlockDraggable(b,a);gBoardLayer.add(b);return b}
function enableBlockDraggable(a,b){a.on("mouseover",function(){document.body.style.cursor="pointer"});a.on("mouseout",function(){document.body.style.cursor="default"});a.on("dragstart",function(){this.setAttrs({blockMoved:0});setBoardState(boardState,this.getAttr("startPosX"),this.getAttr("startPosY"),this.getAttr("style"),0)});a.on("dragend",function(){var a=this.getPosition().x,d=this.getPosition().y,e=point2Pos(a,d),a=e.offsetX>BLOCK_CELL_SIZE/2?minX+(e.posX+1)*BLOCK_CELL_SIZE:minX+e.posX*BLOCK_CELL_SIZE,
d=e.offsetY>BLOCK_CELL_SIZE/2?minY+(e.posY+1)*BLOCK_CELL_SIZE:minY+e.posY*BLOCK_CELL_SIZE,e=point2Pos(a,d),f=this.getAttr("startPosX"),g=this.getAttr("startPosY");this.setPosition(a,d);setBoardState(boardState,e.posX,e.posY,this.getAttr("style"),this.getAttr("id"));a=setStepInfo(b,f,g,e.posX,e.posY,0,0);this.getAttr("blockMoved")&&audioPlayWoodHit();savePlayInfo(gCurSelectedBoard,stepInfo,gHintsCount,manualMoveCount);setPlayModeButtonState();writeStepInfo(a,0==a?0:stepInfo2PosInfo(a).auto);this.setAttrs({startPosX:e.posX,
startPosY:e.posY});this.getLayer().draw();checkGoalState()})}function disableAllBlockDraggable(){for(var a=1;a<blockObj.length;a++)blockObj[a].setDraggable(!1),blockObj[a].off("mouseover mouseout dragstart dragend")}function enableAllBlockDraggable(){for(var a=1;a<blockObj.length;a++)blockObj[a].setDraggable(!0),1==playMode?enableBlockDraggable(blockObj[a],a):editEnableBlockDraggable(blockObj[a])}
var moveObj=[],blockIsMoving=0,ONE_STEP_MOVE_TIME=.17,DEMO_MOVE_SLEEP_TIME=100,HINTS_MOVE_SLEEP_TIME=50;
function moveBlock(a,b,c,d,e){for(var f=a.getAttr("x"),g=a.getAttr("y"),h=b.move[c],k=BLOCK_CELL_SIZE,l=ONE_STEP_MOVE_TIME,n=1;c+n<b.move.length&&h==b.move[c+n];)n++;k*=n;l*=n;switch(h){case "U":g-=k;break;case "D":g+=k;break;case "L":f-=k;break;case "R":f+=k;break;default:error("moveBlock(): design error !");return}f=new Kinetic.Tween({node:a,duration:l,x:f,y:g,onFinish:function(){c+=n;if(c<b.move.length)moveBlock(a,b,c,d,e);else{audioPlayWoodHit();writeStepInfo(curBoardStep,b.auto);for(var f=0;f<
moveObj.length;f++)moveObj[f].destroy();moveObj=[];checkMoveState(d,e)}}});f.play();moveObj.push(f)}
function checkMoveState(a,b){switch(playMode){case 1:0<--b?setTimeout(function(){a(b,1)},HINTS_MOVE_SLEEP_TIME):(blockIsMoving=0,enableFunctionButton(),setPlayModeButtonState(),enableAllBlockDraggable(),checkGoalState());break;case 2:needStopPlay()||0>=--b?(blockIsMoving=0,enableFunctionButton(),setDemoModeButtonState()):setTimeout(function(){a(b,1)},DEMO_MOVE_SLEEP_TIME);break;case 3:needStopPlay()||0>=--b?(blockIsMoving=0,enableFunctionButton(),setEditModeButtonState(),enableAllBlockDraggable(),
enableClearButton(),enableSaveButton()):setTimeout(function(){a(b,1)},DEMO_MOVE_SLEEP_TIME)}}
function moveBack(a,b){"undefined"==typeof a&&(a=1);if(0>=curBoardStep)blockIsMoving=0;else{blockIsMoving=1;var c=1==curBoardStep?0:stepInfo2PosInfo(curBoardStep-1).auto,d=stepInfo2PosInfo(curBoardStep);d.auto=c;var c=blockObj[d.id],e=getStepAction(d,1,0),f=c.getAttr("style");setBoardState(boardState,d.endX,d.endY,f,0);setBoardState(boardState,d.startX,d.startY,f,d.id);c.setPos(d.startX,d.startY);curBoardStep--;0>=curBoardStep&&setDefaultCursor();moveBlock(c,e,0,moveBack,a)}}
function moveNext(a,b){var c=stepInfo.length;"undefined"==typeof a&&(a=1);if(curBoardStep>=c)blockIsMoving=0;else{blockIsMoving=1;curBoardStep++;var d=stepInfo2PosInfo(curBoardStep),e=blockObj[d.id],f=getStepAction(d,0,0);e.getAttr("style");setBoardState(boardState,d.startX,d.startY,e.getAttr("style"),0);setBoardState(boardState,d.endX,d.endY,e.getAttr("style"),d.id);e.setPos(d.endX,d.endY);curBoardStep>=c&&setDefaultCursor();moveBlock(e,f,0,moveNext,a)}}
function moveFirst(a){moveBoardStep(0);a||audioPlayWoodHit();setDefaultCursor()}function moveLast(){moveBoardStep(stepInfo.length);audioPlayWoodHit();setDefaultCursor()}
function moveBoardState(a){if(!(0>a||a>stepInfo.length||a==curBoardStep))switch(!0){case a<curBoardStep:do{var b=stepInfo2PosInfo(curBoardStep),c=blockObj[b.id],d=c.getAttr("style");setBoardState(boardState,b.endX,b.endY,d,0);setBoardState(boardState,b.startX,b.startY,d,b.id);c.setPos(b.startX,b.startY);curBoardStep--}while(a<curBoardStep);break;case a>curBoardStep:do curBoardStep++,b=stepInfo2PosInfo(curBoardStep),c=blockObj[b.id],c.getAttr("style"),setBoardState(boardState,b.startX,b.startY,c.getAttr("style"),
0),setBoardState(boardState,b.endX,b.endY,c.getAttr("style"),b.id),c.setPos(b.endX,b.endY);while(a>curBoardStep)}}function moveBoardStep(a){blockIsMoving||(moveBoardState(a),buildBoard(boardState),setButtonState(),writeStepInfo(a,0==a?0:stepInfo2PosInfo(a).auto))}
function boardState2BoardString(a){for(var b=["@","N","B","H","A"],c=[],d=[],e,f=0;f<G_BOARD_X;f++)d[f]=a[f].slice(0);for(a=0;a<G_BOARD_Y;a++)for(f=0;f<G_BOARD_X;f++)if(0<=(e=d[f][a]))if(0==e)c[f+a*G_BOARD_X]=b[0];else{var g=blockObj[e].getAttr("style"),h=blockObj[e].getAttr("sizeX");e=blockObj[e].getAttr("sizeY");for(var k=0;k<e;k++)for(var l=0;l<h;l++)d[f+l][a+k]=-1,c[f+l+(a+k)*G_BOARD_X]=b[g];b[g]=String.fromCharCode(b[g].charCodeAt(0)+1)}return c.join("")}
function getMaxHintsStep(){var a=Math.floor(gCurSelectedBoard.boardInfo.mini/10);a<MIN_HINTS_STEP&&(a=MIN_HINTS_STEP);a>MAX_HINTS_STEP&&(a=MAX_HINTS_STEP);return a}
function getMoveInfo(a,b){var c,d;c=d=srcStyle=dstStyle=null;for(var e=0;e<a.length&&(null==d||null==c);e++)a[e]!=b[e]&&("@"==a[e]?null==d&&(d=e,dstStyle=b[e]):"@"==b[e]&&null==c&&(c=e,srcStyle=a[e]));e=c%G_BOARD_X;c=(c-e)/G_BOARD_X;var f=d%G_BOARD_X;for(d=(d-f)/G_BOARD_X;0<e&&a[e-1+c*G_BOARD_X]==srcStyle;)e--;for(;0<c&&a[e+(c-1)*G_BOARD_X]==srcStyle;)c--;for(;0<f&&b[f-1+d*G_BOARD_X]==dstStyle;)f--;for(;0<d&&b[f+(d-1)*G_BOARD_X]==dstStyle;)d--;return{startX:e,startY:c,endX:f,endY:d}}
function key2Board(a){var b,c=[],d=["@","N","B","H","A"];b=a&15;c[b]=d[4];c[b+G_BOARD_X]=d[4];c[b+1]=d[4];c[b+1+G_BOARD_X]=d[4];a=Math.floor(a/16);var e=G_BOARD_Y*G_BOARD_X-1;a:for(;0<=e;e--)if(c[e]!=d[4]&&(b=a&3,a>>=2,"undefined"==typeof c[e]))switch(b){case 0:c[e]=d[0];break;case 1:c[e]=d[1];d[1]=String.fromCharCode(d[1].charCodeAt(0)+1);break;case 2:c[e]=d[2];c[e-1]=d[2];d[2]=String.fromCharCode(d[2].charCodeAt(0)+1);break;case 3:c[e]=d[3];c[e-G_BOARD_X]=d[3];d[3]=String.fromCharCode(d[3].charCodeAt(0)+
1);break;default:error("key2Board(): design error !");break a}return c}var findAnswer=new klotskiSolution;
function hints(){var a=boardState2BoardString(boardState),b=getMaxHintsStep();disableFunctionButton();playModeDisableButton();findAnswer.init(a);a=findAnswer.find();if(null!=a.boardList){manualMoveCount=0;var c=a.boardList.length-1;c--}if(null!=a.boardList&&1<=c){gHintsCount++;c<b&&(b=c);for(var c=[],d=0;d<G_BOARD_X;d++)c[d]=boardState[d].slice(0);for(d=1;d<=b;d++){var e=getMoveInfo(key2Board(a.boardList[d-1]),key2Board(a.boardList[d])),f=c[e.startX][e.startY];setStepInfo(f,e.startX,e.startY,e.endX,
e.endY,1,1==d?0:1);var g=blockObj[f].getAttr("style");setBoardState(c,e.startX,e.startY,g,0);setBoardState(c,e.endX,e.endY,g,f)}savePlayInfo(gCurSelectedBoard,stepInfo,gHintsCount,manualMoveCount);disableAllBlockDraggable();moveNext(b)}else setPlayModeButtonState(),enableFunctionButton()}function selectBoard(){gLevelSelectObj.show(playMode)}
function infoBoard(){var a=[],b=[],c=gCurSelectedBoard.boardInfo,d=-1,e=gLevelSelectObj.getAliasName(gCurSelectedBoard.tableId,gCurSelectedBoard.level,gCurSelectedBoard.type);""!=e&&(a[++d]=["c","("+e+")"]);a[++d]=["l",gTxtMsg.BestScore];a[d][1]="undefined"==typeof c.highScore?a[d][1]+"---":a[d][1]+(c.highScore.moves+" "+(1>=c.highScore.moves?gTxtMsg.Step:gTxtMsg.Steps)+" "+c.highScore.hints+" "+gTxtMsg.Hints);a[++d]=["l",gTxtMsg.OptimalSolution+c.mini+" "+(1>=c.mini?gTxtMsg.Step:gTxtMsg.Steps)];
"undefined"!=typeof c.classicAlias&&(a[++d]=["l",gTxtMsg.AliasName+c.classicAlias]);"undefined"!=typeof c.user&&(a[++d]=["l",gTxtMsg.Creator+("user"==c.user?gTxtMsg.userCreator:c.user)]);"undefined"!=typeof c.url&&(e="undefined"==typeof c.url_level?gTxtMsg.Level.replace("%l",c.level):c.url_level,e=""==e?c.url_name:gTxtMsg.LevelOfUrl.replace("%u",c.url_name).replace("%l",e),a[++d]=["l",gTxtMsg.Source+e],b[d]=c.url);okBoard(gCurSelectedBoard.titleInfo,a,b)}
function okBoard(a,b,c){gOKDialog.init("dialogStage",images,boardStageX,boardStageY,a,b,c);gOKDialog.show()}var resetButton,undoButton,redoButton,hintsButton,playModeButton,selectButton,infoButton,volumeButton;
function addPlayModeButton(){var a=boardStartX,b=boardStartY+BOARD_HEIGHT+10,c=images.reset0.width+0;resetButton=new Kinetic.Rect({x:a,y:b,width:images.reset0.width,height:images.reset0.height,fillPatternImage:images.reset0});undoButton=new Kinetic.Rect({x:a+c,y:b,width:images.undo0.width,height:images.undo0.height,fillPatternImage:images.undo0});redoButton=new Kinetic.Rect({x:a+2*c,y:b,width:images.redo0.width,height:images.redo0.height,fillPatternImage:images.redo0});hintsButton=new Kinetic.Rect({x:a+
3*c,y:b,width:images.hints0.width,height:images.hints0.height,fillPatternImage:images.hints0});playModeButton=new Kinetic.Rect({x:a+5*c,y:b,width:images.gameMode1.width,height:images.gameMode1.height,fillPatternImage:images.gameMode1});gButtonLayer.add(resetButton);gButtonLayer.add(undoButton);gButtonLayer.add(redoButton);gButtonLayer.add(hintsButton);gButtonLayer.add(playModeButton);gButtonLayer.draw()}
function clearPlayModeButton(){resetButton.destroy();undoButton.destroy();redoButton.destroy();hintsButton.destroy();playModeButton.destroy()}function disableResetButton(){resetButton.setFillPatternImage(images.reset0);resetButton.off("mouseover click tap");resetButton.on("mouseover",function(){document.body.style.cursor="default"});gButtonLayer.draw()}
function enableResetButton(){resetButton.setFillPatternImage(images.reset1);resetButton.off("mouseover mouseout click tap");resetButton.on("mouseover",function(){document.body.style.cursor="pointer"});resetButton.on("mouseout",function(){document.body.style.cursor="default"});resetButton.on("click tap",function(){moveFirst(0)});gButtonLayer.draw()}
function disableUndoButton(){undoButton.setFillPatternImage(images.undo0);undoButton.off("mouseover click tap");undoButton.on("mouseover",function(){document.body.style.cursor="default"});gButtonLayer.draw()}
function enableUndoButton(){undoButton.setFillPatternImage(images.undo1);undoButton.off("mouseover mouseout click tap");undoButton.on("mouseover",function(){document.body.style.cursor="pointer"});undoButton.on("mouseout",function(){document.body.style.cursor="default"});undoButton.on("click tap",function(){blockIsMoving||(disableAllBlockDraggable(),moveBack())});gButtonLayer.draw()}
function disableRedoButton(){redoButton.setFillPatternImage(images.redo0);redoButton.off("mouseover click tap");redoButton.on("mouseover",function(){document.body.style.cursor="default"});gButtonLayer.draw()}
function enableRedoButton(){redoButton.setFillPatternImage(images.redo1);redoButton.off("mouseover mouseout click tap");redoButton.on("mouseover",function(){document.body.style.cursor="pointer"});redoButton.on("mouseout",function(){document.body.style.cursor="default"});redoButton.on("click tap",function(){blockIsMoving||(disableAllBlockDraggable(),moveNext())});gButtonLayer.draw()}
function disableHintsButton(){hintsButton.setFillPatternImage(images.hints0);hintsButton.off("mouseover click tap");hintsButton.on("mouseover",function(){document.body.style.cursor="default"});gButtonLayer.draw()}
function enableHintsButton(){hintsButton.setFillPatternImage(images.hints1);hintsButton.off("mouseover mouseout click tap");hintsButton.on("mouseover",function(){document.body.style.cursor="pointer"});hintsButton.on("mouseout",function(){document.body.style.cursor="default"});hintsButton.on("click tap",function(){hints()});gButtonLayer.draw()}function disablePlayModeButton(){playModeButton.off("mouseover click tap");playModeButton.on("mouseover",function(){document.body.style.cursor="default"})}
function enablePlayModeButton(){playModeButton.off("mouseover mouseout click tap");playModeButton.on("mouseover",function(){document.body.style.cursor="pointer"});playModeButton.on("mouseout",function(){document.body.style.cursor="default"});playModeButton.on("click tap",function(){savePlayModeInfo();var a=setDemoMode();animateTitle(gTxtMsg.DemoMode,a.time)})}var playModeStepInfo,playModeCurBoardStep;
function savePlayModeInfo(){playModeStepInfo=stepInfo.slice(0);playModeCurBoardStep=curBoardStep}function restorePlayModeInfo(){stepInfo=playModeStepInfo.slice(0);playModeStepInfo=[];curBoardStep=playModeCurBoardStep}
function setAutoMoveStepInfo(){var a=boardState2BoardString(boardState);findAnswer.init(a);var a=findAnswer.find(),b=-1;debug("find answer, elapsed-time: "+a.elapsedTime);null!=a.boardList&&(b=a.boardList.length-1);if(0<b){var c=[];stepInfo=[];for(var d=curBoardStep=0;d<G_BOARD_X;d++)c[d]=boardState[d].slice(0);for(d=1;d<=b;d++){var e=getMoveInfo(key2Board(a.boardList[d-1]),key2Board(a.boardList[d])),f=c[e.startX][e.startY];setStepInfo(f,e.startX,e.startY,e.endX,e.endY,1,1==d?0:1);var g=blockObj[f].getAttr("style");
setBoardState(c,e.startX,e.startY,g,0);setBoardState(c,e.endX,e.endY,g,f)}}return{maxMove:b,time:a.elapsedTime}}function setPlayModeButtonState(){var a=stepInfo.length;0>=curBoardStep||0>=a?disableResetButton():enableResetButton();0>=curBoardStep?disableUndoButton():enableUndoButton();curBoardStep>=a?disableRedoButton():enableRedoButton();manualMoveCount>=ACTIVE_HINTS_COUNT?enableHintsButton():disableHintsButton();enablePlayModeButton()}
function setDefaultCursor(){document.body.style.cursor="default"}function playModeDisableButton(){setDefaultCursor();disableResetButton();disableUndoButton();disableRedoButton();disableHintsButton();disablePlayModeButton()}
function createFunctionButton(){var a=boardStageX-.8*images.select1.width,b=20;selectButton=new Kinetic.Rect({x:a,y:b,scale:{x:.8,y:.8},width:images.select1.width,height:images.select1.height,fillPatternImage:images.select1});b=b+images.select1.height+10;infoButton=new Kinetic.Rect({x:a,y:b,scale:{x:.8,y:.8},width:images.info1.width,height:images.info1.height,fillPatternImage:images.info1});b=b+images.info1.height+10;noAudio||(volumeButton=new Kinetic.Rect({x:a,y:b,scale:{x:.8,y:.8},width:images.volume0.width,
height:images.volume0.height,fillPatternImage:volumeState?images.volume1:images.volume0}));gButtonLayer.add(selectButton);gButtonLayer.add(infoButton);noAudio||gButtonLayer.add(volumeButton);gButtonLayer.draw()}function disableSelectButton(){selectButton.off("mouseover mouseout click tap")}
function enableSelectButton(){selectButton.off("mouseover mouseout click tap");selectButton.on("mouseover",function(){document.body.style.cursor="pointer"});selectButton.on("mouseout",function(){document.body.style.cursor="default"});selectButton.on("click tap",function(){selectBoard()})}function disableInfoButton(){infoButton.off("mouseover mouseout click tap")}
function enableInfoButton(){infoButton.off("mouseover mouseout click tap");infoButton.on("mouseover",function(){document.body.style.cursor="pointer"});infoButton.on("mouseout",function(){document.body.style.cursor="default"});infoButton.on("click tap",function(){3==playMode?infoEditMode():infoBoard()})}var volumeState=1;
function toggleVolumeButton(){(volumeState=!volumeState)?volumeButton.setFillPatternImage(images.volume1):volumeButton.setFillPatternImage(images.volume0);saveConfigInfo();gButtonLayer.draw()}function enableVolumeButton(){noAudio||(volumeButton.off("mouseover mouseout click tap"),volumeButton.on("mouseover",function(){document.body.style.cursor="pointer"}),volumeButton.on("mouseout",function(){document.body.style.cursor="default"}),volumeButton.on("click tap",function(){toggleVolumeButton()}))}
function enableSelectButton(){selectButton.setFillPatternImage(images.select1);selectButton.off("mouseover mouseout click tap");selectButton.on("mouseover",function(){document.body.style.cursor="pointer"});selectButton.on("mouseout",function(){document.body.style.cursor="default"});selectButton.on("click tap",function(){selectBoard()});gButtonLayer.draw()}function disableFunctionButton(){disableSelectButton();disableInfoButton();disableGameButton()}
function enableFunctionButton(){enableSelectButton();enableInfoButton();enableGameButton()}var gameButton,gameMode=1;function createGameButton(){gameButton=new Kinetic.Rect({x:boardStageX-images.game.width,y:boardStageY-images.game.height,width:images.game.width,height:images.game.height,fillPatternImage:images.game});gButtonLayer.add(gameButton);gButtonLayer.draw()}
function enableGameButton(){gameButton.off("mouseover mouseout click tap");gameButton.on("mouseover",function(){document.body.style.cursor="pointer"});gameButton.on("mouseout",function(){document.body.style.cursor="default"});gameButton.on("click tap",function(){gameMode?switch2EditMode():(restorePlayModeInfo(),switch2GameMode());gameMode=!gameMode;gButtonLayer.draw()})}
function switch2EditMode(){gameButton.setFillPatternImage(images.edit);1==playMode&&savePlayModeInfo();setEditMode();animateTitle(gTxtMsg.EditMode)}function switch2GameMode(){gameButton.setFillPatternImage(images.game);setPlayMode(curBoardStep);animateTitle(gTxtMsg.GameMode)}function disableGameButton(){gameButton.off("mouseover mouseout click tap")}
function passLevelCallback(a){a?(a=gLevelSelectObj.getNextLevel(),setSelectedLevel(a,0)):(moveFirst(1),stepInfo=[],manualMoveCount=gHintsCount=0,setPlayModeButtonState());savePlayInfo(gCurSelectedBoard,stepInfo,gHintsCount,manualMoveCount)}
function showPassDialog(a,b){savePlayInfo(gCurSelectedBoard,[],0,0);gPassLevelDialog.init("dialogStage",images,boardStageX,boardStageY,gCurSelectedBoard.titleInfo,gCurSelectedBoard.boardInfo,a,{moves:stepInfo.length,hints:gHintsCount},b,passLevelCallback);gPassLevelDialog.show()}function setScore(){return gLevelSelectObj.setScore({moves:stepInfo.length,hints:gHintsCount})}
function move2Goal(a){var b=a.getAttr("x"),c=a.getAttr("y")+BOARD_BORDER_WIDTH;disableAllBlockDraggable();disableFunctionButton();playModeDisableButton();savePlayInfo(gCurSelectedBoard,[],0,0);var d=new Kinetic.Tween({node:a,duration:1,x:b,y:c,onFinish:function(){var a=gLevelSelectObj.getHighScore(),b=setScore();showPassDialog(a,b);enableFunctionButton();d.destroy();enableAllBlockDraggable()}});audioPlayHappyPass();d.play()}
function checkGoalState(){for(var a,b=0;b<gGoalPos.length;b++)if(a=boardState[gGoalPos[b][0]][gGoalPos[b][1]],0==a||blockObj[a].getAttr("style")!=G_GOAL_STYLE)return!1;move2Goal(blockObj[a]);return!0}var loadingStage;
function showLoadingMsg(a,b,c){document.getElementById(a).style.cssText="top:0px; left:0px; position: absolute;";loadingStage=new Kinetic.Stage({container:a,width:b,height:c});a=new Kinetic.Layer;loadingStage.add(a);b=Math.floor(b)/2-100;c=Math.floor(c)/2-20;a=a.getContext();a.font="40pt Calibri";a.fillStyle="#0000C4";a.strokeStyle="#FFBBCC";a.fillText("Loading.....",b,c)}function hideLoadingMsg(){loadingStage.destroy()}
function savePlayInfo(a,b,c,d){setStorage("klotski_playinfo",JSON.stringify({board:a.boardInfo.board,table:a.tableId,level:a.level,type:a.type,hints:c,moveCount:d,stepInfo:b}))}function restorePlayInfo(){if(dataVersion!=DATA_VERSION)clearStorage("klotski_playinfo");else{var a=getStorage("klotski_playinfo");return null==a?null:JSON.parse(a)}}function saveConfigInfo(){setStorage("klotski_confinfo",JSON.stringify({dataVersion:DATA_VERSION,volume:volumeState,speed:playSpeed}))}
function restoreConfigInfo(){var a=getStorage("klotski_confinfo");null==a?(dataVersion=DATA_VERSION,saveConfigInfo()):(a=JSON.parse(a),volumeState=a.volume,playSpeed=a.speed,"undefined"!=typeof a.dataVersion&&(dataVersion=a.dataVersion),dataVersion!=DATA_VERSION&&saveConfigInfo())}
function animateTitle(a,b){var c=new Kinetic.Text({x:0,y:boardStageY/2-70,text:a,fontSize:70,fontStyle:"bold",fontFamily:"Calibri",fill:"#00FFFF",stroke:"#FFFFFF",width:boardStageX,align:"center"});gBoardLayer.add(c);gBoardLayer.draw();var d=new Kinetic.Tween({node:c,duration:1.5,fontSize:90,opacity:0,onFinish:function(){d.destroy();c.destroy()}});d.play();if("undefined"!=typeof b){var e=new Kinetic.Text({x:0,y:boardStageY/2-70+c.getHeight(),text:b+"s",fontSize:45,fontFamily:"Calibri",fill:"#00FFFF",
stroke:"#FFFFFF",width:boardStageX,align:"center"});gBoardLayer.add(e);var f=new Kinetic.Tween({node:e,duration:1.5,fontSize:65,opacity:0,onFinish:function(){f.destroy();e.destroy()}});gBoardLayer.draw();f.play()}};
