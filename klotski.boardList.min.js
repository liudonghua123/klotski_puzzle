var initBoardUserDefined=[],userDefinedTableId,gBoardTableList=[[initBoardFayaa,"Fayaa"],[initBoardUnblockIt2,"unblock-it-2"],[initBoardWayOut,"Wayout"],[initBoardMine,"Mine"]],gClassicList={tableId:0,list:[1,2,3,4,5,6,7,8,9,10,11,12,13,57,14,15,16,17,18,19,20,21,22,23,24,25,123,26,27,39,40,41,42,43,45,46,47,50,51,52,53,56,406,407,55]},boardAliasName=[[0,2,"\u5c07\u5b88\u89d2\u6a13\uff0c\u6a6b\u5200\u7acb\u99ac2"],[0,7,"\u5175\u81e8\u57ce\u4e0b"],[0,13,"\u5929\u7f85\u5730\u7db2"],[0,16,"\u91cd\u91cd\u5305\u570d"],
[0,19,"\u5175\u5c07\u806f\u9632"],[0,22,"\u5c0f\u71d5\u51fa\u5de2"],[0,24,"\u56db\u9762\u57cb\u4f0f"],[0,27,"\u5de7\u904e\u4e94\u95dc"],[0,43,"\u6a6b\u8c4e\u7686\u5c07"],[0,45,"\u4ea4\u932f\u5835\u9053"],[0,46,"\u524d\u64cb\u5f8c\u5835"],[0,53,"\u56db\u5c07\u806f\u9632"],[0,123,"\u56db\u8def\u7686\u5175"],[0,406,"\u5c07\u64cb\u5f8c\u8def"],[0,407,"\u8abf\u5175\u9063\u5c07"]];function getClassicInfo(){return{id:gClassicList.tableId,list:gClassicList.list}}
function getUserInfo(){return{id:userDefinedTableId,size:initBoardUserDefined.length}}var boardHash=new hashMap;function boardFlip(a){a=a.split("");for(var c=[],d=0;d<G_BOARD_Y;d++)for(var b=0;b<G_BOARD_X;b++)c[gRowMajorToIndex(G_BOARD_X-b-1,d)]=a[gRowMajorToIndex(b,d)];return c.join("")}function addClassicAliasName(){for(var a=0;a<boardAliasName.length;a++)gBoardTableList[boardAliasName[a][0]][0][boardAliasName[a][1]-1].classicAlias=boardAliasName[a][2]}
function genBoardList(){var a=okBoards=wrongBoards=0,c,d=[];addClassicAliasName();for(var b=0;b<gBoardTableList.length;b++){for(var e=c=0;e<gBoardTableList[b][0].length;e++){var f=gBoardTableList[b][0][e];f.level=e+1;a++;addBoardInfo2Hash(f,b)?0>=f.mini?wrongBoards++:d[okBoards++]={tableId:b,level:f.level}:c++}gBoardTableList[b][2]=c}debug(boardHash.size()+" "+boardHash.avage());for(b=0;b<gBoardTableList.length;b++)f=gBoardTableList[b][0],debug(gBoardTableList[b][1]+": total level = "+f.length+", dupicate boards = "+
gBoardTableList[b][2]);debug("Total boards = "+a+" good boards = "+okBoards+" wrong boards = "+wrongBoards);d.sort(function(a,b){var c=gBoardTableList[a.tableId][0][a.level-1].mini-gBoardTableList[b.tableId][0][b.level-1].mini;0==c&&(c=a.tableId-b.tableId,0==c&&(c=a.level-b.level));return c});restoreUserDefinedBoard();gBoardTableList.push([initBoardUserDefined,"user-defined"]);userDefinedTableId=gBoardTableList.length-1;for(e=wrongBoards=c=a=0;e<initBoardUserDefined.length;e++)f=initBoardUserDefined[e],
f.level=e+1,f.user="user",a++,addBoardInfo2Hash(f,userDefinedTableId)||c++;debug("----------------------------------------------------------------------");debug("User Defined boards = "+a+", duplicate boards = "+c);debug("----------------------------------------------------------------------");restoreScore();return d}
function addBoardInfo2Hash(a,c){var d=gBoard2Key(gEasyBoard(a.board)),b=gBoard2Key(gEasyBoard(boardFlip(a.board))),e=a.level,f=1;null!=boardHash.put(d,{tableId:c,level:e,flip:0})?(d=boardHash.get(d).value,debug("srcItem: level "+e+" of "+gBoardTableList[c][1]),debug("existItem: level "+d.level+" of "+gBoardTableList[d.tableId][1]+(d.flip?" (flip)":"")),debug("======> same board!!!"),debug(""),f=0):d!=b&&null!=boardHash.put(b,{tableId:c,level:e,flip:1})&&(d=boardHash.get(b).value,debug("srcItem: level "+
e+" of "+gBoardTableList[c][1]+" (flip)"),debug("existItem: level "+d.level+" of "+gBoardTableList[d.tableId][1]+(d.flip?" (flip)":"")),debug("======> same board!!!"),debug(""),f=0);return f}function getBoardInfo(a,c){return gBoardTableList[a][0][c-1]}function findBoard(a){a=gBoard2Key(gEasyBoard(a));a=boardHash.get(a);return null==a?null:a.value}
function setBoardScore(a,c,d){var b=gBoardTableList[a][0][c-1].highScore;return"undefined"==typeof b||d.moves<b.moves||d.moves==b.moves&&d.hints<b.hints?(gBoardTableList[a][0][c-1].highScore=d,saveScore(),1):0}function getBoardHighScore(a,c){return gBoardTableList[a][0][c-1].highScore}
function addUserDefinedBoard(a,c){var d=initBoardUserDefined.length+1,b={level:d,mini:c,board:a,user:"user"};return addBoardInfo2Hash(b,userDefinedTableId)?(initBoardUserDefined.push(b),saveUserDefinedBoard(),{table:userDefinedTableId,level:d,board:a,type:TABS_TYPE.USER}):null}function saveUserDefinedBoard(){for(var a=[],c=0;c<initBoardUserDefined.length;c++)a[c]={mini:initBoardUserDefined[c].mini,board:initBoardUserDefined[c].board};setStorage("klotski_board",JSON.stringify(a))}
function restoreUserDefinedBoard(){if(dataVersion!=DATA_VERSION)clearStorage("klotski_board");else{var a=getStorage("klotski_board");null!=a&&(initBoardUserDefined=JSON.parse(a))}}
function removeUserDefinedBoard(a){for(var c=a;c<initBoardUserDefined.length;c++){var d=initBoardUserDefined[c].board,b=gBoard2Key(gEasyBoard(d)),d=gBoard2Key(gEasyBoard(boardFlip(d)));boardHash.remove(b)||error("failed to remove user-defined from hash!");b!=d&&(boardHash.remove(d)||error("failed to remove user-defined (flip) from hash!"))}initBoardUserDefined.splice(a,1);for(c=a;c<initBoardUserDefined.length;c++)a=initBoardUserDefined[c],a.level=c+1,addBoardInfo2Hash(a,userDefinedTableId)||error("failed to shift user-defined item:"+
c);saveUserDefinedBoard();saveScore()}function saveScore(){for(var a={},c=0;c<gBoardTableList.length;c++)for(var d=gBoardTableList[c][0],b=0;b<d.length;b++){var e=d[b].highScore;if("undefined"!=typeof e){var f=d[b].mini,g=c==userDefinedTableId?"ID"+String("00"+b).slice(-3):String("0"+c).slice(-2)+String("00"+b).slice(-3);a[g]=(((e.moves&65535)<<16)+((e.hints&255)<<8)+(f&255)).toString(16)}}setStorage("klotski_score",JSON.stringify(a))}
function restoreScore(){if(dataVersion!=DATA_VERSION)clearStorage("klotski_score");else{var a=getStorage("klotski_score");if(null!=a){for(var a=JSON.parse(a),c=gBoardTableList.length,d=[],b=0;b<c;b++)d[b]=gBoardTableList[b][0].length;var e=0,f;for(f in a){var b=parseInt(f.slice(0,2),10),g=parseInt(f.slice(2),10);isNaN(b)&&(b=userDefinedTableId);if(!(b>=c||g>=d[b])){var h=parseInt(a[f],16),k=h>>16&65535,l=h>>8&255;gBoardTableList[b][0][g].mini==(h&255)&&(gBoardTableList[b][0][g].highScore={moves:k,
hints:l},e++)}}debug("klotski_score count = "+e)}}};
