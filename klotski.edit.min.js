var clearButton,verifySaveButton;
function addEditModeButton(){var b=images.first0.width+0,c=boardStartX-b/2,a=boardStartY+BOARD_HEIGHT+10;clearButton=new Kinetic.Rect({x:c,y:a,width:images.reset0.width,height:images.reset0.height,fillPatternImage:images.reset0});c+=10;firstButton=new Kinetic.Rect({x:c+b,y:a,width:images.first0.width,height:images.first0.height,fillPatternImage:images.first0});backButton=new Kinetic.Rect({x:c+2*b,y:a,width:images.back0.width,height:images.back0.height,fillPatternImage:images.back0});playButton=new Kinetic.Rect({x:c+
3*b,y:a,width:images.play2.width,height:images.play2.height,fillPatternImage:images.play2});nextButton=new Kinetic.Rect({x:c+4*b,y:a,width:images.next0.width,height:images.next0.height,fillPatternImage:images.next0});lastButton=new Kinetic.Rect({x:c+5*b,y:a,width:images.last0.width,height:images.last0.height,fillPatternImage:images.last0});verifySaveButton=new Kinetic.Rect({x:c+10+6*b,y:a,width:images.reset0.width,height:images.reset0.height,fillPatternImage:images.test0});gButtonLayer.add(clearButton);
gButtonLayer.add(firstButton);gButtonLayer.add(backButton);gButtonLayer.add(playButton);gButtonLayer.add(nextButton);gButtonLayer.add(lastButton);gButtonLayer.add(verifySaveButton);gButtonLayer.draw()}function clearEditModeButton(){clearButton.destroy();firstButton.destroy();backButton.destroy();playButton.destroy();nextButton.destroy();lastButton.destroy();verifySaveButton.destroy()}var editModeCanSave=0;
function disableVerifyButton(){verifySaveButton.setFillPatternImage(images.test0);verifySaveButton.off("mouseover mouseout click tap");gButtonLayer.draw()}
function enableVerifyButton(){verifySaveButton.setFillPatternImage(images.test1);verifySaveButton.off("mouseover mouseout click tap");verifySaveButton.on("mouseover",function(){document.body.style.cursor="pointer"});verifySaveButton.on("mouseout",function(){document.body.style.cursor="default"});verifySaveButton.on("click tap",function(){var b=setAutoMoveStepInfo().maxMove;if(0<b){var c=boardState2BoardString(boardState),c=findBoard(c);if(null!=c){var a=gLevelSelectObj.tableLevel2TitleName(c.tableId,
c.level);audioPlayExist();editModeCanSave=0;disableSaveButton();okBoard(gTxtMsg.Exist,[["l",gTxtMsg.SameAs.replace("%s",a)+(c.flip?" ("+gTxtMsg.Flip+")":"")],["l",gTxtMsg.OptimalSolution+b+" "+(1>=b?gTxtMsg.Step:gTxtMsg.Steps)]])}else audioPlayGood(),editModeCanSave=1,enableSaveButton(),okBoard(gTxtMsg.Good,[["l",gTxtMsg.OptimalSolution+b+" "+(1>=b?gTxtMsg.Step:gTxtMsg.Steps)]]);moveBoardStep(0)}else audioPlayError(),editModeCanSave=0,disableVerifyButton(),0>b?okBoard(gTxtMsg.Error,[["l",gTxtMsg.NoSolution+
"    "]]):okBoard(gTxtMsg.Error,[["l",gTxtMsg.ZeroStep]]),editModeDisableButton()});gButtonLayer.draw()}function disableSaveButton(){verifySaveButton.setFillPatternImage(images.save0);verifySaveButton.off("mouseover mouseout click tap");gButtonLayer.draw()}
function saveBoard(){var b=new confirmDialog;disableSaveButton();moveFirst(1);if(getUserInfo().size>=gLevelSelectObj.maxLevelSize())editModeCanSave=0,audioPlayError(),okBoard(gTxtMsg.TooManyItem,[["l",gTxtMsg.RemoveSome]]);else{var c=boardState2BoardString(boardState);editModeCanSave=0;c=addUserDefinedBoard(c,stepInfo.length);null!=c?(audioPlaySuccess(),b.init("dialogStage",images,boardStageX,boardStageY,gTxtMsg.SaveSuccess,[gTxtMsg.NewLevel+" '"+gTxtMsg.UserLevel+c.level+"'",gTxtMsg.PlayItNow],playAfterSave,
c),b.show()):okBoard(gTxtMsg.Exist,[["l","Error: This board style already exist !"]])}}function playAfterSave(b,c){if(b){var a=gLevelSelectObj.changeSelectedBoard(c);null!=a&&(gCurSelectedBoard=a,stepInfo=[],curBoardStep=manualMoveCount=gHintsCount=0);switch2GameMode();gameMode=!gameMode}}
function enableSaveButton(){editModeCanSave&&(verifySaveButton.setFillPatternImage(images.save1),verifySaveButton.off("mouseover mouseout click tap"),verifySaveButton.on("mouseover",function(){document.body.style.cursor="pointer"}),verifySaveButton.on("mouseout",function(){document.body.style.cursor="default"}),verifySaveButton.on("click tap",function(){blockIsMoving||saveBoard()}),gButtonLayer.draw())}
function disableClearButton(){clearButton.setFillPatternImage(images.reset0);clearButton.off("mouseover mouseout click tap");gButtonLayer.draw()}
function enableClearButton(){clearButton.setFillPatternImage(images.reset1);clearButton.off("mouseover mouseout click tap");clearButton.on("mouseover",function(){document.body.style.cursor="pointer"});clearButton.on("mouseout",function(){document.body.style.cursor="default"});clearButton.on("click tap",function(){for(var b=0;b<G_BOARD_X;b++)for(var c=0;c<G_BOARD_Y;c++){var a=boardState[b][c];if(a){var a=blockObj[a],d=a.getPosition().x,e=a.getPosition().y;a.setAttrs({curBoardPosX:-1,curBoardPosY:-1});
setBoardState(boardState,b,c,a.getAttr("style"),0);a.moveToTop();blockMoveTo(a,d,e,a.getAttr("defaultPointX"),a.getAttr("defaultPointY"))}}numOfEmptyCell=G_BOARD_SIZE;hasBigBlock=0;disableClearButton();checkBoardState();writeStepInfo(0)});gButtonLayer.draw()}var hasBigBlock=0,numOfEmptyCell=0;function countBoardState(b,c){var a=gBlockStyle[b][0]*gBlockStyle[b][1]*(c?-1:1);4==b&&(hasBigBlock=c?1:0);numOfEmptyCell+=a}
function checkBoardState(){2==numOfEmptyCell&&hasBigBlock?enableVerifyButton():(disableVerifyButton(),editModeDisableButton())}function setEditModeButtonState(){var b=stepInfo.length;0>=curBoardStep||0>=b?disableFirstButton():enableFirstButton();0>=curBoardStep?disableBackButton():enableBackButton();curBoardStep>=b?(disableNextButton(),disablePlayButton(),disableLastButton()):(enableNextButton(),enableStartPlayButton(),enableLastButton())}
function editModeDisableButton(){disableFirstButton();disableBackButton();disablePlayButton();disableNextButton();disableLastButton()}var blockGap,editMinX,editMinY;
function createEditBoard(){var b=[[14,1,1],[6,0,2],[6,0,0],[1,0,3]],c=[[14,0,0],[6,1,2],[6,0,1],[1,1,0]];numOfEmptyCell=G_BOARD_SIZE;blockGap=10;editMinX=15;boardStartX<=3*BLOCK_CELL_SIZE+blockGap+2*editMinX?(c=b,blockGap=0,editMinY=Math.floor(boardStartY+BOARD_HEIGHT-5*BLOCK_CELL_SIZE)):editMinY=Math.floor(boardStartY+(BOARD_HEIGHT-3*BLOCK_CELL_SIZE-blockGap)/2);boardState=[];for(b=0;b<G_BOARD_X;b++){boardState[b]=[];for(var a=0;a<G_BOARD_Y;a++)boardState[b][a]=0}gBoardLayer.removeChildren();b=1;
blockObj=[];for(a=0;a<c.length;a++)for(var d=0;d<c[a][0];d++)blockObj[b]=createEditBlock(b,c[a][1],c[a][2],a+1),b++;gBoardLayer.draw()}
function createEditBlock(b,c,a,d){c=editMinX+BLOCK_CELL_SIZE*c+(0<c?blockGap:0);a=editMinY+BLOCK_CELL_SIZE*a+(0<a?blockGap:0);b=new Kinetic.Rect({id:b,defaultPointX:c,defaultPointY:a,curBoardPosX:-1,curBoardPosY:-1,sizeX:gBlockStyle[d][0],sizeY:gBlockStyle[d][1],style:d,x:c,y:a,width:BLOCK_CELL_SIZE*gBlockStyle[d][0]-CELL_BORDER_SIZE,height:BLOCK_CELL_SIZE*gBlockStyle[d][1]-CELL_BORDER_SIZE,fillPatternImage:images["block"+d],strokeWidth:CELL_BORDER_SIZE,draggable:!0});b.setPos=function(a,c){this.setAttrs({curBoardPosX:a,
curBoardPosY:c})};b.movePos=function(a,c){var b=minX+a*BLOCK_CELL_SIZE,d=minY+c*BLOCK_CELL_SIZE;this.setAttrs({curBoardPosX:a,curBoardPosY:c});this.setPosition(b,d)};editEnableBlockDraggable(b);gBoardLayer.add(b);return b}
function editEnableBlockDraggable(b){b.on("mouseover",function(){document.body.style.cursor="pointer"});b.on("mouseout",function(){document.body.style.cursor="default"});b.on("dragstart",function(){0<=this.getAttr("curBoardPosX")&&(setBoardState(boardState,this.getAttr("curBoardPosX"),this.getAttr("curBoardPosY"),this.getAttr("style"),0),this.setAttrs({curBoardPosX:-1,curBoardPosY:-1}),countBoardState(this.getAttr("style"),0),checkBoardState());this.moveToTop()});b.on("dragend",function(){var c=this.getPosition().x,
a=this.getPosition().y,b=editPoint2Pos(c,a);0>b.posX||!canInsert2Board(boardState,b.posX,b.posY,this.getAttr("style"))?blockMoveTo(this,c,a,this.getAttr("defaultPointX"),this.getAttr("defaultPointY")):(c=minX+b.posX*BLOCK_CELL_SIZE,a=minY+b.posY*BLOCK_CELL_SIZE,this.setPosition(c,a),this.setAttrs({curBoardPosX:b.posX,curBoardPosY:b.posY}),setBoardState(boardState,b.posX,b.posY,this.getAttr("style"),this.getAttr("id")),countBoardState(this.getAttr("style"),1),checkBoardState());numOfEmptyCell==G_BOARD_SIZE?
disableClearButton():enableClearButton();this.getLayer().draw()})}function editPoint2Pos(b,c){var a=posY=0,d=b-minX;0>d&&(d<-BLOCK_CELL_SIZE/2&&(a=-1),d=0);for(;d>=BLOCK_CELL_SIZE;)d-=BLOCK_CELL_SIZE,a++;var e=c-minY;0>e&&(e<-BLOCK_CELL_SIZE/2&&(posY=-1),e=0);for(;e>=BLOCK_CELL_SIZE;)e-=BLOCK_CELL_SIZE,posY++;d>BLOCK_CELL_SIZE/2&&a++;e>BLOCK_CELL_SIZE/2&&posY++;if(a>=G_BOARD_X||posY>=G_BOARD_Y||0>a||0>posY)posY=a=-1;return{posX:a,posY:posY}}
function canInsert2Board(b,c,a,d){var e=1;switch(d){case 1:b[c][a]&&(e=0);break;case 2:if(c>G_BOARD_X-2||b[c][a]||b[c+1][a])e=0;break;case 3:if(a>G_BOARD_Y-2||b[c][a]||b[c][a+1])e=0;break;case 4:if(c>G_BOARD_X-2||a>G_BOARD_Y-2||b[c][a]||b[c+1][a]||b[c][a+1]||b[c+1][a+1])e=0;break;default:error("canInsert2Board(): design error!"),e=0}return e}
function blockMoveTo(b,c,a,d,e){c=(Math.abs(c-d)+Math.abs(a-e))/BLOCK_CELL_SIZE;10<c&&(c=10);2>c&&(c=2);debug(c/20);var g=new Kinetic.Tween({node:b,duration:c/20,x:d,y:e,onFinish:function(){g.destroy()}});g.play()}
function setEditBoard(b){var c=[];boardState=[];for(var a=0;a<G_BOARD_X;a++){boardState[a]=[];for(var d=0;d<G_BOARD_Y;d++)boardState[a][d]=-1}for(var e=1;e<blockObj.length;e++)a=blockObj[e],a.setAttrs({curBoardPosX:-1,curBoardPosY:-1}),a.setPosition(a.getAttr("defaultPointX"),a.getAttr("defaultPointY"));numOfEmptyCell=G_BOARD_SIZE;for(var g=hasBigBlock=0,d=0;d<G_BOARD_Y;d++)for(a=0;a<G_BOARD_X;a++)if(0<=boardState[a][d])g++;else{var f=gBlockBelongTo[b.charCodeAt(g++)-63];if(f){if("undefined"==typeof c[f])for(e=
1;e<blockObj.length;e++){if(blockObj[e].getAttr("style")==f){c[f]=e;break}}else e=++c[f];(e>=blockObj.length||blockObj[e].getAttr("style")!=f)&&error("Too few blocks for style = "+f);blockObj[e].movePos(a,d);countBoardState(f,1)}setBoardState(boardState,a,d,f,f?e:0)}enableClearButton();checkBoardState();editModeDisableButton();gBoardLayer.draw()}function infoEditMode(){okBoard(gTxtMsg.EditMode,[["l",gTxtMsg.EditModeMsg]])};
